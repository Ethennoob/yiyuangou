<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>一元购</title>
    <!--页面窗口自动调整到设备宽度，并禁止用户缩放页面-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0,
    minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <!-- 关闭电话号码识别： -->
    <meta name="format-detection" content="telephone=no" />
    <!-- 关闭邮箱地址识别： -->
    <meta name="format-detection" content="email=no" />

    <link rel="stylesheet" href="../assets/css/base.css" />
    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="../assets/css/swiper.min.css" />
</head>
<body class="bg-grey" id="goodsDetailApp">
    <!--顶栏-->
    <div class="text-center bg-white top-bar">商品详情页
        <a href="javascript: history.back();">
            <img class="back" src="../assets/i/back.png" />
        </a>
        <a href="../personal.html?user_id={{userId}}">
            <img class="personal-top-link" src="../assets/i/personal-logo.png" />
        </a>
    </div>

    <!--商品轮播图-->
    <div v-show="goods.img.length == 6" class="swiper-container bd-bottom bd-grey">
        <div class="swiper-wrapper">
            <div class="swiper-slide">
                <img v-bind:src="goods.img[0]" width="100%">
            </div>
            <div class="swiper-slide">
                <img v-bind:src="goods.img[1]" width="100%">
            </div>
            <div class="swiper-slide">
                <img v-bind:src="goods.img[2]" width="100%">
            </div>
            <div class="swiper-slide">
                <img v-bind:src="goods.img[3]" width="100%">
            </div>
            <div class="swiper-slide">
                <img v-bind:src="goods.img[4]" width="100%">
            </div>
            <div class="swiper-slide">
                <img v-bind:src="goods.img[5]" width="100%">
            </div>
        </div>
        <!-- 进度条 -->
        <div class="swiper-pagination"></div>
    </div>

    <!--商品名称&简介-->
    <div class="padding-horizontal-10 padding-vertical-14 bd-bottom bd-grey bg-white">
        <span class="f15 block">{{goods.goods_name}}</span>
        <!--<span class="f14 font-grey mt5 block">{{goods.goods_title}}</span>-->
    </div>

    <!--参与人数进度条-->
    <div class="padding-horizontal-10 padding-vertical-14 bd-bottom bd-grey bg-white f15 grid-container">

        <div class="row mb10">
            <div class="col-xs-9">价值：￥{{goods.price}}
            </div>
            <div class="col-xs-3 text-right">限购{{goods.limit_num}}人次
            </div>
        </div>

        <div class="progress cf">
            <div class="progress-bar" v-bind:style="{width: progressWidth}"></div>
        </div>

        <div class="row mt10">
            <div class="col-xs-4">
                <span class="block">{{goods.purchase_num}}</span>已参与
            </div>
            <div class="col-xs-4 text-center">
                <span class="block">{{goods.total_num}}</span>总需人次
            </div>
            <div class="col-xs-4 text-right">
                <span class="block">{{goods.last_num}}</span>剩余
            </div>
        </div>

    </div>

    <!--参与记录、图文详情入口-->
    <ul class="link-list bg-white f15 margin-vertical-20">
        <li>
            <a href="../join-record.html?goods_id={{goodsId}}" class="block">
                <span class="ml10">参与记录</span>
            </a>
        </li>
        <li>
            <a href="../goods-img-detail.html?goods_id={{goodsId}}" class="block">
                <span class="ml10">图文详情（建议在WI-FI下使用）</span>
            </a>
        </li>
    </ul>

    <!--立即一元购按钮-->
    <div class="padding-horizontal-10 padding-vertical-10 bg-white bd-top bd-grey margin-vertical-20">
        <button v-show="goods.last_num > 0" class="btn bg-red width-full font-white br4 buy-btn goods-popup-trigger">
            立即一元购
        </button>
        <button v-else disabled="disabled"  class="btn bg-grey width-full br4 buy-btn">
            已售完
        </button>
    </div>


    <div class="popup goods-popup" role="alert">
        <div class="popup-container padding-vertical-10 bg-grey">
            <a href="javascript:;" class="popup-close goods-popup-close"></a>
            <div class="padding-horizontal-20 bd-bottom bd-grey mb10">
                <div class="f15 font-grey">剩余{{goods.last_num}}人次</div>
                <div class="margin-vertical-10 f15">{{goods.goods_title}}</div>
            </div>
            <div class="goods-counter text-left padding-horizontal-20">
                <span class="subtract" v-on:click="numCut">-</span><span class="count-box">{{num}}</span><span class="add" v-on:click="numAdd">+</span>
                <span class="ml10">限购{{goods.limit_num}}人次</span>
            </div>
            <div class="text-left padding-vertical-10 padding-horizontal-20">
                合计：<span class="font-red f20">{{num}}</span>
                <span class="font-red f18">元</span>
            </div>
            <div class="padding-horizontal-20">
                <button v-on:click="callpay()" class="btn br4 width-full bg-red font-white" >去结算</button>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="../assets/js/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/vue.js"></script>
    <script type="text/javascript" src="../assets/js/base.js"></script>
    <script type="text/javascript" src="../assets/js/swiper.min.js"></script>
    <!--<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>-->
    <script type="text/javascript">
        var goodsDetailApp = new Vue({
            el: '#goodsDetailApp',
            data: {
                userId: getParam('user_id'),
                goodsId: getParam('goods_id'),
                goods: {},
                num: 1
            },
            ready: function() {
                var swiper = new Swiper('.swiper-container', {
                    pagination: '.swiper-pagination',
                    paginationClickable: true,
                    observer:true,
                    autoHeight: true
                });

                //结算弹框
                $('.goods-popup-trigger').on('click', function(event){
                    event.preventDefault();
                    $('.goods-popup').addClass('is-visible');
                });
                //关闭结算弹框
                $('.goods-popup').on('click', function(event){
                    if( $(event.target).is('.goods-popup-close') || $(event.target).is('.goods-popup') ) {
                        event.preventDefault();
                        $(this).removeClass('is-visible');
                    }
                });
            },
            computed: {
                progressWidth: function() {
                    var buyProgress = Math.floor((this.goods.purchase_num / this.goods.total_num) * 100);
                    return buyProgress.toString() + '%';
                }
            },
            methods:{
                numAdd: function() {
                    if(this.num < this.goods.limit_num){
                        this.num ++;
                    }
                },
                numCut: function() {
                    if(this.num > 1){
                        this.num --;
                    }
                },
                callpay: function() {
                    $.post('http://onebuy.ping-qu.com/Api/Wechatpay/purchase',
                            {
                                goods_sn: this.goods.goods_sn,
                                price: totalPrice
                            }
                    ).done(function (data) {
                        wx.chooseWXPay({
                            timestamp: 0, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                            nonceStr: '', // 支付签名随机串，不长于 32 位
                            package: '', // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                            signType: '', // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                            paySign: '', // 支付签名
                            success: function (res) {
                                // 支付成功后的回调函数
                            }
                        });
                    }).fail(function() {
                        alert('请求失败');
                    });

//                    if (typeof WeixinJSBridge == "undefined"){
//                        if( document.addEventListener ){
//                            document.addEventListener('WeixinJSBridgeReady', this.jsApiCall, false);
//                        }else if (document.attachEvent){
//                            document.attachEvent('WeixinJSBridgeReady', this.jsApiCall);
//                            document.attachEvent('onWeixinJSBridgeReady', this.jsApiCall);
//                        }
//                    }else{
//                        this.jsApiCall();
//                    }
                }
//                ,
//                jsApiCall: function() {
//                    var totalPrice = this.num;
//                    $.post('http://onebuy.ping-qu.com/Api/Wechatpay/purchase',
//                            {
//                                goods_sn: this.goods.goods_sn,
//                                price: totalPrice
//                            }
//                    ).done(function (data) {
//                        WeixinJSBridge.invoke(
//                                'getBrandWCPayRequest',
//                                {
//                                    "appId": data.data.wechatPay.appId,     //公众号名称，由商户传入
//                                    "timeStamp": data.data.wechatPay.timeStamp,         //时间戳，自1970年以来的秒数
//                                    "nonceStr": data.data.wechatPay.nonceStr, //随机串
//                                    "package": data.data.wechatPay.package,
//                                    "signType": data.data.wechatPay.signType,         //微信签名方式：
//                                    "paySign": data.data.wechatPay.paySign //微信签名
//                                },
//                                function(res){
//                                    WeixinJSBridge.log(res.err_msg);
//                                    alert(res.err_code+res.err_desc+res.err_msg);
//                                }
//                        );
//                    }).fail(function () {
//                        alert("请求失败");
////                        alert(totalPrice);
//                    });
//                }
            }
        });

        $.post('http://onebuy.ping-qu.com/Api/Goods/purchaseOneDetail', {goods_id: getParam('goods_id')}).done(function (data) {
            goodsDetailApp.goods = data.data.goodinfo;
        }).fail(function () {
            alert("请求失败");
        });

//        wx.config({
//            debug: true,
//            appId: '', // 必填，公众号的唯一标识
//            timestamp: '', // 必填，生成签名的时间戳
//            nonceStr: '', // 必填，生成签名的随机串
//            signature: '',// 必填，签名，见附录1
//            jsApiList: [
//                    'chooseWXPay'
//            ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
//        });
    </script>
</body>
</html>